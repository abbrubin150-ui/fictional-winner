name: Deploy PCS

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:  # ◊û◊ê◊§◊©◊® ◊î◊§◊¢◊ú◊î ◊ô◊ì◊†◊ô◊™

env:
  NODE_VERSION: '20.x'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Build project
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30

  deploy-github-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'dist'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/

    - name: Create Release Archive
      run: |
        tar -czf pcs-${{ github.ref_name }}.tar.gz dist/
        zip -r pcs-${{ github.ref_name }}.zip dist/

    - name: Extract release notes
      id: extract-notes
      run: |
        if [ -f CHANGELOG.md ]; then
          # ◊û◊ó◊ú◊• ◊ê◊™ ◊î◊í◊®◊°◊î ◊î◊†◊ï◊õ◊ó◊ô◊™ ◊û◊î-CHANGELOG
          awk '/^## \[/{if(p)exit;p=1;next} p' CHANGELOG.md > release-notes.md
        else
          echo "Release ${{ github.ref_name }}" > release-notes.md
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release-notes.md
        files: |
          pcs-${{ github.ref_name }}.tar.gz
          pcs-${{ github.ref_name }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-notification:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-github-pages]
    if: always()

    steps:
    - name: Deployment Status
      run: |
        BUILD_RESULT="${{ needs.build-and-test.result }}"
        DEPLOY_RESULT="${{ needs.deploy-github-pages.result }}"

        echo "Build result: $BUILD_RESULT"
        echo "Deploy result: $DEPLOY_RESULT"

        if [ "$BUILD_RESULT" == "success" ] && [ "$DEPLOY_RESULT" == "success" ]; then
          echo "‚úÖ Deployment successful!"
          echo "üéâ PCS deployed successfully to GitHub Pages"
        elif [ "$BUILD_RESULT" == "failure" ]; then
          echo "‚ùå Build or tests failed"
          exit 1
        elif [ "$DEPLOY_RESULT" == "failure" ]; then
          echo "‚ùå Deployment failed"
          exit 1
        elif [ "$DEPLOY_RESULT" == "skipped" ]; then
          echo "‚è≠Ô∏è Deployment skipped (not on main branch)"
          exit 0
        else
          echo "‚è≠Ô∏è Deployment skipped or cancelled"
          exit 0
        fi
