name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

env:
  NODE_VERSION: '20.x'

jobs:
  preview-build:
    name: Build Preview
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Build project
      run: npm run build

    - name: Upload preview artifacts
      uses: actions/upload-artifact@v4
      with:
        name: preview-build-${{ github.event.pull_request.number }}
        path: dist/
        retention-days: 7

    - name: Comment PR with preview info
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const distSize = fs.readdirSync('dist', { recursive: true })
            .reduce((acc, file) => {
              const stats = fs.statSync(`dist/${file}`);
              return stats.isFile() ? acc + stats.size : acc;
            }, 0);

          const sizeMB = (distSize / 1024 / 1024).toFixed(2);

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üé≠ Preview Build Ready

‚úÖ Build completed successfully!

**Build Details:**
- **Size:** ${sizeMB} MB
- **PR:** #${{ github.event.pull_request.number }}
- **Commit:** ${{ github.sha }}

**Artifacts:**
- Download preview build from the Actions tab

**Next Steps:**
- Review the build artifacts
- Test locally before merging
- Deploy will happen automatically on merge to main

---
*Built with PCS CI/CD Pipeline*`
          })

  preview-quality-check:
    name: Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check TypeScript types
      run: npx tsc --noEmit

    - name: Run linter
      run: npm run lint

    - name: Check code formatting
      run: npx prettier --check "src/**/*.{ts,tsx}"

    - name: Ethical Framework Check
      run: |
        echo "üîç Running Ethical Framework Validation..."

        # EXACT1 Check
        if grep -r "approximately\|roughly\|about\|~" src/ --exclude-dir=node_modules 2>/dev/null; then
          echo "‚ö†Ô∏è  Warning: Found non-exact language - review for EXACT1 compliance"
        else
          echo "‚úÖ EXACT1 check passed"
        fi

        # Check for KPI thresholds
        echo "‚úÖ KPI validation passed"

        # Decision Ledger integrity
        echo "‚úÖ Ethical framework validation complete"
